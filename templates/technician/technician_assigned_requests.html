{% extends "base.html" %}
{% load static %}

{% block title %}Assigned Requests{% endblock %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-4">Assigned Requests</h1>

  {% if assigned_requests %}
    <div class="row">
      {% for request in assigned_requests %}
        <div class="col-md-4 mb-4">
          <div class="card shadow-sm h-100">

            <div class="card-header bg-primary text-white">
              <h5 class="card-title mb-0">{{ request.title }}</h5>
            </div>

            <div class="card-body">
              <p>
                <strong>Status:</strong>
                {% if request.status == "In Progress" %}
                  <span class="badge bg-warning text-dark">{{ request.status }}</span>
                {% elif request.status == "Completed" %}
                  <span class="badge bg-success">{{ request.status }}</span>
                {% else %}
                  <span class="badge bg-secondary">{{ request.status }}</span>
                {% endif %}
              </p>

              <p>
                <strong>Priority:</strong>
                {% if request.priority %}
                  {{ request.priority.name }}
                {% else %}
                  N/A
                {% endif %}
              </p>

              <p>
                <strong>Created At:</strong> {{ request.created_at|date:"M d, Y H:i" }}
              </p>
            </div>

            <div class="card-footer text-end">
              <a href="{% url 'technician_request_detail' request.id %}" class="btn btn-sm btn-info mb-1">
                <i class="fas fa-eye"></i> Details
              </a>

              <form method="post" action="{% url 'technician_accept_request' request.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-success mb-1 ml-1">
                  <i class="fas fa-check"></i> Accept
                </button>
              </form>

              <button type="button" class="btn btn-sm btn-danger mb-1 ml-1" data-toggle="modal" data-target="#rejectModal{{ request.id }}">
                <i class="fas fa-times"></i> Reject
              </button>
            </div>

          </div>
        </div>

        <!-- Reject Modal -->
        <div class="modal fade" id="rejectModal{{ request.id }}" tabindex="-1" role="dialog" aria-labelledby="rejectModalLabel{{ request.id }}" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <form method="post" action="{% url 'technician_reject_request' request.id %}">
              {% csrf_token %}
              <div class="modal-content">

                <div class="modal-header">
                  <h5 class="modal-title" id="rejectModalLabel{{ request.id }}">Reject Request #{{ request.id }}</h5>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>

                <div class="modal-body">
                  <label for="reason{{ request.id }}" class="form-label">Reason for rejection:</label>
                  <textarea name="reason" id="reason{{ request.id }}" class="form-control" rows="3" required></textarea>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-danger">Confirm Reject</button>
                </div>

              </div>
            </form>
          </div>
        </div>

      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted mt-3">No assigned requests found.</p>
  {% endif %}

</div>
{% endblock %}
