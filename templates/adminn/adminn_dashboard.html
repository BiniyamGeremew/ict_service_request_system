{% extends "base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<section class="content">
  <div class="container-fluid pt-3">

    <!-- Welcome -->
    <div class="row mb-3">
      <div class="col-12">
        <h2>Welcome, {{ user.username }}</h2>
      </div>
    </div>

 <!-- Quick Action Buttons -->
<div class="row mb-4">
  <div class="col-12 d-flex flex-wrap justify-content-between">
    <a href="{% url 'add_user' %}" class="btn btn-primary btn-sm shadow-sm mx-1">
      <i class="fas fa-user-plus"></i> Add User
    </a>
    <a href="{% url 'view_users' %}" class="btn btn-info btn-sm shadow-sm mx-1">
      <i class="fas fa-users"></i> Manage Users
    </a>
    <a href="{% url 'all_requests' %}" class="btn btn-warning btn-sm shadow-sm mx-1">
      <i class="fas fa-tasks"></i> Manage Requests
    </a>
    <a href="{% url 'service_category' %}" class="btn btn-success btn-sm shadow-sm mx-1">
      <i class="fas fa-cogs"></i> Service Categories
    </a>
    <a href="{% url 'request_reports' %}" class="btn btn-secondary btn-sm shadow-sm mx-1">
      <i class="fas fa-file-alt"></i> Generate Reports
    </a>
  </div>
</div>




    <!-- Charts -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card card-primary">
          <div class="card-header"><h3 class="card-title">Users by Role</h3></div>
          <div class="card-body">
            <canvas id="userRoleChart" style="height:250px"></canvas>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card card-info">
          <div class="card-header"><h3 class="card-title">Requests by Status</h3></div>
          <div class="card-body">
            <canvas id="requestStatusChart" style="height:250px"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-12">
        <div class="card card-success">
          <div class="card-header"><h3 class="card-title">Requests by Category</h3></div>
          <div class="card-body">
            <canvas id="categoryChart" style="height:250px"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Latest Requests Table -->
    <div class="row">
      <div class="col-12">
        <div class="card card-secondary">
          <div class="card-header"><h3 class="card-title">Latest Requests</h3></div>
          <div class="card-body table-responsive p-0" style="max-height: 300px;">
            <table class="table table-hover text-nowrap">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Created By</th>
                  <th>Created At</th>
                </tr>
              </thead>
              <tbody>
                {% for req in latest_requests %}
                <tr>
                  <td>{{ req.id }}</td>
                  <td>{{ req.title }}</td>
                  <td>{{ req.category.name }}</td>
                  <td>{{ req.status }}</td>
                  <td>{{ req.created_by.username }}</td>
                  <td>{{ req.created_at|date:"M d, Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="6">No requests found.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'adminLTE/plugins/chart.js/chart.min.js' %}"></script>
<script>
  // Users by Role
  const userLabels = JSON.parse('{{ user_roles_labels_json|escapejs }}'); 
  const userCounts = JSON.parse('{{ user_roles_counts_json|escapejs }}');

  new Chart(document.getElementById('userRoleChart').getContext('2d'), {
      type: 'bar',
      data: { labels: userLabels, datasets: [{ label: 'Users Count', data: userCounts, backgroundColor: ['#007bff','#28a745','#ffc107','#dc3545'] }] },
      options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { precision:0 } } } }
  });

  // Requests by Status
  const statusLabels = JSON.parse('{{ status_labels_json|escapejs }}');
  const statusCounts = JSON.parse('{{ status_counts_json|escapejs }}');

  new Chart(document.getElementById('requestStatusChart').getContext('2d'), {
      type: 'bar',
      data: { labels: statusLabels, datasets: [{ label: 'Requests Count', data: statusCounts, backgroundColor: ['#007bff','#28a745','#ffc107','#17a2b8','#6c757d','#dc3545'] }] },
      options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { precision:0 } } } }
  });

  // Requests by Category
  const categoryLabels = JSON.parse('{{ category_labels_json|escapejs }}');
  const categoryCounts = JSON.parse('{{ category_counts_json|escapejs }}');

  new Chart(document.getElementById('categoryChart').getContext('2d'), {
      type: 'bar',
      data: { labels: categoryLabels, datasets: [{ label: 'Requests Count', data: categoryCounts, backgroundColor: ['#007bff','#28a745','#ffc107','#dc3545','#6c757d','#17a2b8'] }] },
      options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { precision:0 } } } }
  });
</script>
{% endblock %}
